# 常用工具整理

体检工具
-------

生产环境不同于开发环境，开发环境中很小的问题比如内存泄漏几KB，在生产环境随着时间的累积或者成千上万的访问，可能会把垃圾回收器搞崩溃。这种情况如果我们不擅于使用工具可能找不到任何问题。

### dstat

它能实时查看一些基本信息，默认情况下它会包括:

* CPU基本信息（用户使用时间、系统使用时间、空闲时间等）
* 磁盘基本信息（读、写）
* 网络基本信息（接受、发送）
* 换入换出信息
* 系统基本信息（中断的次数、上下文切换的次数）

如下所示:
```
[ubuntu] ~/.mac $ dstat
You did not select any stats, using -cdngy by default.
--total-cpu-usage-- -dsk/total- -net/total- ---paging-- ---system--
usr sys idl wai stl| read  writ| recv  send|  in   out | int   csw
  0   0 100   0   0|2797B  597B|   0     0 |   0     0 |  90   236
  0   0 100   0   0|   0     0 |   0     0 |   0     0 | 140   323
  0   0 100   0   0|   0     0 |   0     0 |   0     0 | 163   376
  0   1 100   0   0|   0     0 |   0     0 |   0     0 | 169   391
```

生产环境下我们程序出错的时候，应该先从大的方面入手定位到具体是哪个方面的问题，看看当前的系统环境有没有问题，是不是我们的程序在当前的系统环境下水土不服。比如程序是IO密集型的，系统中有另一个程序在和它抢磁盘资源等。可以通过`dstat --list`查看它能对哪些细分项目查看其情况。[查看更多使用示例](http://dag.wiee.rs/home-made/dstat/)


### sysstat

通过定位了系统中哪个方面的问题之后，接着我们应该去定位我们自己程序哪个方面有问题。sysstat可以根据单个进程去检查它的各个方面，比如说我们定位到是内存方面的问题，接着去看自己程序中内存的问题:
```
[ubuntu] ~/.mac $ pidstat -r -p `pidof tmux` 2
Linux 4.9.184-linuxkit (cabd4e519687) 	12/09/19 	_x86_64_	(2 CPU)

10:02:38      UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
10:02:40        0        35      0.00      0.00   27424    4000   0.20  tmux: server
10:02:42        0        35      0.00      0.00   27424    4000   0.20  tmux: server
10:02:44        0        35      0.00      0.00   27424    4000   0.20  tmux: server
10:02:46        0        35      0.00      0.00   27424    4000   0.20  tmux: server
```
我们把tmux当做是自己写的某个程序，每2秒输出一次信息。minflt/s就代表一些小范围的缺页异常，可能是一些数据不需要了只要补上相应的物理内存即可。而majflt/s代表了需要从硬盘换入内存，这可能就意味着我们程序是不是有的任务优先级太低被操作系统换出到硬盘上了，我们可能需要通过系统调用告诉操作系统把某段内存锁死。

更详细的使用方法，请参考[官方文档](http://sebastien.godard.pagesperso-orange.fr/documentation.html)。